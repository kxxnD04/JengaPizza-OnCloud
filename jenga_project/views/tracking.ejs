<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçï</text></svg>">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <title>Jenga Pizza</title>
    <style>
        @font-face {
            font-family: Prompt;
            src: url("fonts/Prompt-Regular.ttf");
        }

        body {
            font-family: Prompt;
        }

        /* Background Image */
        body::before {
            content: "";
            position: fixed;
            width: 100%;
            height: 100%;
            background-image: url("<%= S3_BUCKET_URL %>/images/bg-pizza.jpg");
            opacity: 0.1;
            z-index: -1;
        }

        .box {
            text-align: center;
            width: 100%;
        }

        /* Fix Flexbox Centering */
        .container-center {
            margin: auto;
            display: flex;
            align-items: center;  /* Ensure vertical centering */
            width: 80%;
            min-height: calc(100vh - 60px); /* Adjust for navbar */
            padding-top: 60px; /* Prevent overlap with navbar */
            padding-bottom: 60px;
        }
        .order-icon {
            width: 80px;
            height: 80px;

        }

        .status {
            font-weight: bold;
            font-size: 1.1em;
        }

        .preparing {
            color: orange;
        }

        .pending {
            color: orangered;
        }

        .delivering {
            color: darkorange;
        }

        .success {
            color: green;
        }

    </style>
</head>
<body>

    <header>
        <%- include('header') %>
    </header>

    <!-- choose to buy -->
    <div class="container-center">
        <div class="container mt-4">
            <h2 class="font-weight-bold">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
            <div class="row">
                <!-- Order List -->
                <div class="col-md-12">
                    <div class="order-card">

                        <% for(var i=0; i < order.length; i++) { %>

                            <div class="row align-items-center p-3 border rounded bg-white shadow-sm mb-3">
                                <div class="col-2">
                                    <% 
                                        let statusImage = order[i].order_status;
                                        if (order[i].order_status === 'cancelled' || order[i].order_status === 'rejected') {
                                            statusImage = 'cancelled';
                                        }
                                    %>
                                    <img src="<%= S3_BUCKET_URL %>/images/<%= statusImage %>.png" class="order-icon">
                                </div>
                                <div class="col-6">
                                    <h5 id="order-<%= order[i].order_id %>">Order No. <%= order[i].order_id %></h5>
                                    <p class="text-muted">‡∏£‡∏≤‡∏Ñ‡∏≤ : <%= order[i].total_price %> ‡∏ö‡∏≤‡∏ó</p>
                                    <p class="text-muted">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î : <%= order[i].receiver_name %>, <%= order[i].house_no %> <%= order[i].village_no %> <%= order[i].street %> <%= order[i].sub_district %> <%= order[i].district %> <%= order[i].province %> <%= order[i].postal_code %> <%= order[i].country %></p>
                                    <p class="text-muted timestamp">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏°‡∏∑‡πà‡∏≠ : </p>
                                </div>
                                <div class="col-4 text-right">
                                    <span class="status <%= order[i].order_status %>"> <%= order[i].order_status %> </span>
                                    
                                    <% if (order[i].order_status === 'pending') { %>
                                        <div class="mt-3">
                                            <button class="btn btn-danger btn-cancel-order" data-order-id="<%= order[i].order_id %>">
                                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                                            </button>
                                        </div>
                                    <% } %>
                                </div>
                            </div>

                        <% } %>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ -->
    <div class="modal fade" id="cancelOrderModal" role="dialog" aria-labelledby="cancelOrderModalLabel">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="cancelOrderModalLabel">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ?</p>
                    <p class="text-muted">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="confirmCancelBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
    <div class="modal fade" id="resultModal" role="dialog" aria-labelledby="resultModalLabel">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header" id="resultModalHeader">
                    <h5 class="modal-title" id="resultModalLabel">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="resultModalBody">
                    <!-- Message will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">‡∏ï‡∏Å‡∏•‡∏á</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function getCurrentDateTime() {
            const now = new Date();
            
            // Format date as DD/MM/YYYY
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            
            // Format time as hh:mm
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            // Return formatted date and time
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        $(document).ready(function () {
            $('.timestamp').each(function() {
                $(this).text('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏°‡∏∑‡πà‡∏≠ : ' + getCurrentDateTime());
            });
            
            let orderId = $(this).data('order-id');
            $(`select[data-order-id="${orderId}"]`).closest('.row').find('p.text-muted:last').text('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏°‡∏∑‡πà‡∏≠ : ' + getCurrentDateTime());

        });

        // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        let selectedOrderId = null;

        $(".btn-cancel-order").on("click", function (e) {
            e.preventDefault();
            selectedOrderId = $(this).data("order-id");
            $('#cancelOrderModal').modal('show');
        });

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î Modal (‡∏õ‡∏∏‡πà‡∏° X)
        $('#cancelOrderModal').on('hidden.bs.modal', function () {
            selectedOrderId = null;
        });

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏Å‡∏ö‡∏≤‡∏ó (X) ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î Modal ‡πÑ‡∏î‡πâ
        $('#cancelOrderModal .close').on('click', function() {
            $('#cancelOrderModal').modal('hide');
        });

        $('#resultModal .close').on('click', function() {
            $('#resultModal').modal('hide');
        });

        // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å Modal
        $(document).on('click', '.modal', function(e) {
            if ($(e.target).hasClass('modal')) {
                $(this).modal('hide');
            }
        });

        $('#resultModal').on('hidden.bs.modal', function () {
            // Reset modal header class
            $('#resultModalHeader').removeClass('bg-success bg-danger text-white');
        });

        // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏≤‡∏Å Modal
        $("#confirmCancelBtn").on("click", function () {
            if (selectedOrderId) {
                // ‡∏õ‡∏¥‡∏î modal ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á loading
                $('#cancelOrderModal').modal('hide');
                
                fetch('/cancel_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: selectedOrderId })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showResultModal('success', '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', data.message || '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } else {
                            showResultModal('danger', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showResultModal('danger', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
                    });
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Result Modal
        function showResultModal(type, title, message) {
            $('#resultModalLabel').text(title);
            $('#resultModalBody').text(message);
            $('#resultModalHeader').removeClass('bg-success bg-danger').addClass('bg-' + type + ' text-white');
            $('#resultModal').modal('show');
        }
    </script>
    <footer>
        <%- include('footer') %>
    </footer>


</body>
</html>
